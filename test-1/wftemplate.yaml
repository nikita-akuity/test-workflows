apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: test-terraform
  namespace: wf
  labels:
    example: 'true'
spec:
  serviceAccountName: executor
  entrypoint: tf-run
  arguments:
    parameters:
    - name: wf-configmap-name
      value: wf-defaults-cm
  templates:
  - name: tf-run
    inputs:
      parameters:
      - name: git-url
        valueFrom:
          configMapKeyRef:
            name: '{{workflow.parameters.wf-configmap-name}}'
            key: tf-git-url
      - name: git-revision
        valueFrom:
          configMapKeyRef:
            name: '{{workflow.parameters.wf-configmap-name}}'
            key: tf-git-revision
      artifacts:
        - name: git-repo
          path: /src
          git:
            repo: '{{inputs.parameters.git-url}}'
            revision: '{{inputs.parameters.git-revision}}'
    metadata: {}
    script:
      name: tf-run
      image: 'hashicorp/terraform:1.2.6'
      workingDir: /src/test-1/tf
      command:
      - sh
      source: |
        terraform init &&
        terraform plan -var-file=test.tfvars &&
        terraform apply -auto-approve -var-file=test.tfvars
      resources: {}
  ttlStrategy:
    secondsAfterCompletion: 300
  podGC:
    strategy: OnWorkflowSuccess
  workflowMetadata:
    labels:
      example: 'true'
